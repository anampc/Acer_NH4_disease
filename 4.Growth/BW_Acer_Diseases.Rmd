---
title: "Acer_BW_Disease"
author: "Ana M. Palacio"
date: "`r Sys.Date()`"
output:
  html_document:
      toc: true
      df_print: paged
      theme: united
bibliography: packages.bib
nocite: '@*'
editor_options:
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning=FALSE, message=FALSE) 
                      #fig.width=4, fig.height=3 )
```

# General project set-up 

```{r libraries, results="hide"}

# Libraries
  library(reshape2)
  library(tidyverse)

# Graphs
<<<<<<< HEAD
theme_set (theme_classic() + theme(panel.grid.major = element_blank(),
                              panel.grid.minor = element_blank(), 
                              axis.line = element_line(colour = "black"),
                              legend.position="none",
                              axis.text.x = element_text(angle = 90, vjust = 0.5),
                              plot.title = element_text(size=12, face="bold"),
                              #panel.border = element_rect(colour = "black", fill=NA, size=1)
                              panel.border = element_blank()
                              ))

    
# Data    
  # Fragment list
  #CurrentFragments<-read.csv("Metadata/Fragment_Replicate.csv", header = T)

  # Collection information
  #Location<-read.csv("Metadata/Genotype_Origin.csv", header = T)
```


# Meta data

* Treatments, Genotypes, Tags

```{r}

# Treatment Info
  Treatment<-read.csv("Data/Treatments.csv")
  #duplicated(Treatment$Tag)
  Treatment<-Treatment[!duplicated(Treatment$Tag), ]
  #duplicated(Tags$Tag)
  summary(Treatment)

# Tags weight
  Tags<-read.csv("Data/Tags_W.csv")
  #duplicated(Tags$Tag)
  Tags<-Tags[!duplicated(Tags$Tag), ]
  #duplicated(Tags$Tag)
  summary(Tags)
  
  Tags$SW_den<-(999.842594+0.06793952*(Tags$Temperature)-0.00909529*(Tags$Temp)^2+0.0001001685*
    (Tags$Temperature)^3-0.000001120083*(Tags$Temperature)^4+0.000000006536332*(Tags$Temp)^5+(0.824493-0.0040899*
    (Tags$Temperature)+0.000076438*(Tags$Temperature)^2-0.00000082467*(Tags$Temperature)^3+0.0000000053875*
    (Tags$Temperature)^4)*(Tags$Salinity)+(-0.00572466+0.00010227*(Tags$Temperature)-0.0000016546*
    (Tags$Temperature)^2)* (Tags$Salinity)^1.5+0.00048314*(Tags$Salinity)^2)*0.001
  
   #Tags$Estimated_Density<-(-Tags$SW_den/((Tags$T_BW/Tags$T_AW)-1))
   
  library(dplyr)
  Tags %>%
      group_by(T_Type) %>%
      summarise_at(vars(T_AW, T_BW), funs(mean(., na.rm=TRUE)))

```

# BW data 

```{r}

# 1. BW data
  BW_Tall<-read.csv("Data/BW_ Long_data.csv")
  
  #BW_Tall$Estimated.W.density[BW_Tall$Estimated.W.density == "#VALUE!" ] <-NA
  #BW_Tall$Estimated.W.density<-as.numeric(as.character(BW_Tall$Estimated.W.density))
  
  #BW_Tall$Estimated_AW [BW_Tall$Estimated_AW == "#VALUE!" ] <-NA
  #BW_Tall$Estimated_AW<-as.numeric(as.character(BW_Tall$Estimated_AW))
  
# 2. Data clean-up an types: 
  
  # Variable types 
    #BW_Tall$Time <- as.factor(BW_Tall$Time)
    #BW_Tall$Time<-as.numeric(BW_Tall$Time)
    BW_Tall$Date<-as.Date(BW_Tall$Date, "%Y-%m-%d")
    BW_Tall$Day<-(as.numeric(BW_Tall$Date)-18486)
  
  # Remove-unused data    
    #Extras <- BW_Tall[which (BW_Tall$Nutrients=="Extra"), ]
    #BW_Tall <- droplevels(BW_Tall[!rownames(BW_Tall) %in%
    #                                   rownames(Extras), ])

# 3. Merge with treatments
    BW_Tall<-plyr::join(BW_Tall, Treatment, by = "Tag", 
                type = "left", match = "all")

    BW_Tall<-plyr::join(BW_Tall, Tags, by = "Tag", 
                type = "left", match = "all")
    
    BW_Tall$Nutrients<-factor(BW_Tall$Nutrients, 
                             levels= c("Ambient", "NH4"), ordered=TRUE)
    BW_Tall$Disease<-factor(BW_Tall$Disease, 
                             levels= c("Placebo", "Pathogen"), ordered=TRUE)

# 4. Replicates
    BW_Tall$Tank<-factor(BW_Tall$Tank, ordered=FALSE)
    BW_Tall$Genotype<-factor(BW_Tall$Genotype, ordered=FALSE)

    summary(BW_Tall)

```

# BW 

## BW calculations

```{r}
    
BW.data<-BW_Tall[order(BW_Tall$Tag), ]

# 3. Calculate days bw BW data points
BW.data<-BW.data %>%
  group_by(Tag) %>%
  dplyr::mutate(Days = Day - lag(Day, default = Day[1]))

# 4. Calculate change in BW bw data points
BW.data<-BW.data %>%
  group_by(Tag) %>%
  dplyr::mutate(dBW = BW - lag(BW, default = BW[1]))

BW.data<-BW.data %>%
  group_by(Tag) %>%
  dplyr::mutate(dBW_r = dBW/(Days*lag(BW, default = BW[1])))

BW.data<-BW.data %>%
  group_by(Tag) %>%
  dplyr::mutate(dBW_r = dBW/(Days*lag(BW, default = BW[1])))

BW.data$dBW_r<-BW.data$dBW_r*1000

summary(BW.data)
```


## BW Exploration 

```{r}
SizeBiasCheck<- ggplot(BW.data, aes (BW, dBW_r, colour=factor(Genotype))) +
  #geom_smooth(method = "lm")+
  geom_jitter(alpha=0.5) + ggthe_bw +
  scale_y_continuous(limits = c(0, 5),
                         breaks = seq(0, 6,2),  
                         expand = c(0, 0),
                         name=("AW mg / g*day"))
SizeBiasCheck
```

### Genotype

```{r}
 
BW_Genet<- ggplot(BW.data, aes (Genotype, dBW_r, colour=factor(Genotype))) +
  stat_summary(fun.data = "mean_cl_boot",geom = "errorbar", width = 0.2 )+
  stat_summary(fun.y=mean, geom="line") + 
  geom_jitter(alpha=0.5) + ggthe_bw +
  scale_y_continuous(limits = c(0, 5),
                         breaks = seq(0, 5,1),  
                         expand = c(0, 0),
                         name=("dBW [mg / g*day]"))
  
BW_Genet
BW_Genet+ facet_wrap(~Nutrients)
BW_Genet+ facet_wrap(~Disease)
#BW_Genet+ facet_wrap(Nutrients~Disease)
```



# AW

## AW Calculations

```{r}

# 1. Coral BW
  BW.data$Coral_BW<-(BW.data$BW)-(BW.data$T_BW)

# 2. Water density

  BW.data$SW_den<-(999.842594+0.06793952*(BW.data$Temp)-0.00909529*(BW.data$Temp)^2+0.0001001685*
    (BW.data$Temp)^3-0.000001120083*(BW.data$Temp)^4+0.000000006536332*(BW.data$Temp)^5+(0.824493-0.0040899*
    (BW.data$Temp)+0.000076438*(BW.data$Temp)^2-0.00000082467*(BW.data$Temp)^3+0.0000000053875*(BW.data$Temp)^4)*
    (BW.data$Salinity)+(-0.00572466+0.00010227*(BW.data$Temp)-0.0000016546*(BW.data$Temp)^2)*
    (BW.data$Salinity)^1.5+0.00048314*(BW.data$Salinity)^2)*0.001
    
# 3. Coral air weight
  BW.data$Est_Coral_AW<-(BW.data$Coral_BW)*(1/(1-(BW.data$SW_den)/2.4))
  
# 4. Calculate change in AW bw data points
  BW.data<-BW.data %>%
    dplyr::group_by(Tag) %>%
    dplyr::mutate(dAW = Est_Coral_AW - lag(Est_Coral_AW, default = Est_Coral_AW[1]))

BW.data<-BW.data %>%
  group_by(Tag) %>%
  dplyr::mutate(dAW_r = dAW/(Days*lag(Est_Coral_AW, default = Est_Coral_AW[1])))


BW.data$dAW_r<-BW.data$dAW_r*1000

summary(BW.data)

```

## AW Exploration 

```{r}
SizeBiasCheck<- ggplot(BW.data, aes (Est_Coral_AW, dAW_r, colour=factor(Genotype))) +
  #stat_summary(fun.data = "mean_cl_boot",geom = "errorbar", width = 0.2 )+
  #stat_summary(fun.y=mean, geom="line") + 
  geom_jitter(alpha=0.5) + ggthe_bw +
  scale_y_continuous(limits = c(0, 10),
                         breaks = seq(0, 10,2),  
                         expand = c(0, 0),
                         name=("dAW [mg / g*day]"))
SizeBiasCheck
```


### Genotype

```{r}
 
AW_Genet<- ggplot(BW.data, aes (Genotype, dAW_r, colour=factor(Genotype))) +
  stat_summary(fun.data = "mean_cl_boot",geom = "errorbar", width = 0.2 )+
  stat_summary(fun.y=mean, geom="line") + 
  theme(legend.position = "none")+
  geom_jitter(alpha=0.5) + 
  scale_y_continuous(limits = c(0, 10),
                         breaks = seq(0, 10,2),  
                         expand = c(0, 0),
                         name=("AW mg / g*day"))
 
AW_Genet
AW_Genet+ facet_wrap(~Nutrients)
AW_Genet+ facet_wrap(~Disease)
AW_Genet+ facet_wrap(Nutrients~Disease)
```


# Packages used

```{r}
# Creates bibliography 
#knitr::write_bib(c(.packages()), "packages.bib")
```
