---
title: "Acer NH4 anaysis"
author: "Ana Palacio"
date: "`r Sys.Date()`"
output:
  html_document:
      toc: true
      df_print: paged
      theme: united
bibliography: packages.bib
nocite: '@*'
editor_options:
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning=FALSE, message=FALSE) 
                      #fig.width=4, fig.height=3 )
```

# General project set-up 

```{r libraries, results="hide"}

# Libraries
  library(reshape2)
  library(tidyverse)
  library(tidyr)
  library(lubridate)
  library(gridExtra)


# Graphs

theme_set (theme_classic() + theme(panel.grid.major = element_blank(),
                              panel.grid.minor = element_blank(), 
                              axis.line = element_line(colour = "black"),
                              legend.position="bottom",
                              axis.text.x = element_text(angle = 90, vjust = 0.5),
                              plot.title = element_text(size=12, face="bold"),
                              #panel.border = element_rect(colour = "black", fill=NA, size=1)
                              panel.border = element_blank()
                              ))
```


# Data

## Nutrients

```{r}
# Nutrients

Nutrients<-read.csv("Data/Nutrient samples_round5.csv")
  summary(Nutrients)
  
  Nutrients$Date<-as.Date(Nutrients$Date, "%m-%d-%Y")
  Nutrients$Time<-paste(Nutrients$Date, Nutrients$Hour, sep = " ")
  Nutrients$Time<-strptime(Nutrients$Time, "%Y-%m-%d %H:%M:%S")
  Nutrients$Time <- as.POSIXct(Nutrients$Time)
  Nutrients$Date <- as.Date(Nutrients$Time)
  Nutrients$Day<-as.numeric(Nutrients$Date)-18518
  Nutrients$Week<-(Nutrients$Day)/7
  Nutrients$Week<-as.integer(Nutrients$Week)+1
  summary(Nutrients)
  

# Tall format
  Nutrients.tall <- gather(Nutrients, Nutrient, Concentration, 
                      NH4:PO4.uM., factor_key=TRUE)
  Nutrients.tall$Date<-as.Date(Nutrients.tall$Date, "%m-%d-%Y")
  #Nutrients.tall$Time<-paste(Nutrients.tall$Date, Nutrients$Hour, sep = " ")
  summary(Nutrients.tall)
  
```

## Salinity and precipitation

```{r}
# Precipitation
  Precipitation<-read.csv("Data/Precipitation.csv")

  Precipitation$Time<-paste(Precipitation$Date, Precipitation$Hour, sep = " ")
  Precipitation$Time<-strptime(Precipitation$Time, "%Y-%m-%d %H:%M:%S")
  Precipitation$Time <- as.POSIXct(Precipitation$Time)

  Precipitation$Date<-as.Date(Precipitation$Date, "%Y-%m-%d")
  

# Salinity
  Salinity<-read.csv("Data/System.csv")
  Salinity$Time<-strptime(Salinity$Time, "%m/%d/%Y %H:%M:%S")
  Salinity$Time <- as.POSIXct(Salinity$Time)
  Salinity$Date <- as.Date(Salinity$Time)
  Salinity$Day<-as.numeric(Salinity$Date)-18518
  Salinity$Week<-(Salinity$Day)/7
  Salinity$Week<-as.integer(Salinity$Week)+1
  summary(Salinity)
```

# NH4

```{r}
NH4Plot<- ggplot(filter(Nutrients, Treatment!="Source"),
                       aes (Week, NH4, fill=Treatment)) +
  stat_summary(fun.data = "mean_cl_boot",geom = "errorbar", width = 0.2 )+
  stat_summary(fun=mean, geom="line") + 
  stat_summary(fun=mean, geom="point", shape=21) +
  scale_x_continuous(limits = c(1, 9),
                      breaks = seq(1, 9, 1),  
                      expand = c(0.1, 0))+
  scale_y_continuous(#limits = c(0, 20),
                     # breaks = seq(0, 35, 2),  
                     # expand = c(0, 0),
                          name=expression(NH[4]~"["~mu~"M]"))+
  geom_vline(xintercept=5.5, linetype="dashed")+
  geom_vline(xintercept=8, linetype="dashed")
NH4Plot
```

# PO4

```{r}
PH4_plot<- ggplot(filter(Nutrients, Treatment!="Source"),
                       aes (Week, PO4.uM., fill=Treatment)) +
  stat_summary(fun.data = "mean_cl_boot",geom = "errorbar", width = 0.2 )+
  stat_summary(fun=mean, geom="line") + 
  stat_summary(fun=mean, geom="point", shape=21) +
   scale_x_continuous(limits = c(1, 9),
                      breaks = seq(1, 9, 1),  
                      expand = c(0.1, 0))+
  scale_y_continuous(name=expression(PO[4]~"["~mu~"M]"))+
  geom_vline(xintercept=5.5, linetype="dashed")+
  geom_vline(xintercept=8, linetype="dashed")
PH4_plot
```

# Summary nutrients

```{r}
grid.arrange(NH4Plot, PH4_plot, ncol=2)
```


## Salinity

```{r}
Summary.Salinity<- Salinity %>%
  group_by(Date)%>%
  dplyr::summarise(mean=mean(Salinity), 
            min=min(Salinity),
            max=max(Salinity))

Summary.Salinity<-left_join(Summary.Salinity, Precipitation, by=("Date"))
Summary.Salinity$Precipitation<-as.numeric(Summary.Salinity$Precipitation)

summary(Summary.Salinity)
```

```{r}
Salinity_summary<- ggplot(Salinity, aes (x=Week)) +
  geom_line(aes(y=min), colour="blue", data = Summary.Salinity)+
  geom_line(aes(y=max), colour="red", data = Summary.Salinity)+
  geom_line(aes(y=mean), colour="black", data = Summary.Salinity)+
  geom_line(aes(y=Precipitation*10), colour="black")+
  geom_hline(yintercept = 30, linetype=3)+
  geom_hline(yintercept = 33, linetype=3)+
  
  # Data collection
  geom_vline(xintercept = as.Date("2020-08-12"), linetype=3)+
  geom_vline(xintercept = as.Date("2020-09-04"), linetype=3)+
  geom_vline(xintercept = as.Date("2020-09-11"), linetype=3)+
  geom_vline(xintercept = as.Date("2020-09-14"), linetype=4)+
  geom_vline(xintercept = as.Date("2020-09-18"), linetype=3)+
  geom_vline(xintercept = as.Date("2020-09-25"), linetype=3)+
  geom_vline(xintercept = as.Date("2020-10-02"), linetype=3)+
  geom_vline(xintercept = as.Date("2020-10-09"), linetype=3)+
  
  geom_hline(yintercept = 33, linetype=3)+
  
  scale_y_continuous(limits = c(0, 36),
                         breaks = seq(0, 35, 2),  
                         expand = c(0.01, 0),
                         name=("Salinity (?)"))+
  scale_x_date(breaks = "3 day", 
                   #limits = c(Sys.Date() - 20, NA),
                    #limits = as.Date(c("2020-09-14","2020-10-03")),
                    name=("Date"))

Salinity_summary

```


```{r}
All_summary<- ggplot() +
  
  geom_hline(yintercept = 30, linetype=3)+
  geom_hline(yintercept = 33, linetype=3)+
  
  # Data collection
  geom_vline(xintercept = as.Date("2020-08-12"), linetype=3)+
  geom_vline(xintercept = as.Date("2020-08-21"), linetype=3)+
  geom_vline(xintercept = as.Date("2020-09-04"), linetype=3)+
  geom_vline(xintercept = as.Date("2020-09-11"), linetype=3)+
  geom_vline(xintercept = as.Date("2020-09-14"), linetype=4)+
  geom_vline(xintercept = as.Date("2020-09-18"), linetype=3)+
  geom_vline(xintercept = as.Date("2020-09-25"), linetype=3)+
  geom_vline(xintercept = as.Date("2020-10-02"), linetype=3)+
  geom_vline(xintercept = as.Date("2020-10-09"), linetype=3)+
  
  geom_line(data=Summary.Salinity, aes(x=Date, y=min), colour="blue")+
  geom_line(data=Summary.Salinity, aes(x=Date, y=max), colour="red")+
  geom_line(data=Summary.Salinity, aes( x=Date, y=mean), colour="black")+
  
  geom_line(data=Summary.Salinity, aes(x=Date, y=Precipitation+20), colour="black")+
  geom_point(data=Summary.Salinity, aes(x=Date, y=Precipitation+20), colour="black", alpha=1, size=1)+
  
  #geom_line(data=Nutrients, aes (x=as.Date(Time), y=NH4, group=factor(Tank), 
  #                               colour=Treatment), linetype=2) +
  #geom_point(data=Nutrients, aes (x=as.Date(Time), y=NH4, group=factor(Tank),
   #                               colour=Treatment), alpha=1, size=2, shape=21) +
  geom_line(data=Nutrients, aes (x=Date, y=PO4.uM., group=factor(Tank), 
                                 colour=Treatment), linetype=1) +
  
  
  scale_y_continuous(limits = c(0, 36),
                         breaks = seq(0, 35, 2),  
                         expand = c(0.01, 0),
                         name=("Salinity / NH4 (uM) / Precipitation +20in"))+
  scale_x_date(breaks = "3 day", 
                   #limits = c(Sys.Date() - 20, NA),
                    #limits = as.Date(c("2020-09-14","2020-10-03")),
                    name=("Date"))
All_summary

```


```{r}
# Temperature

Samples <- data.frame(table(Nutrients$Sample.ID))
  colnames(Samples)<-c("Sample.ID","RanA")
  Nutrients_sample<-plyr::join(Nutrients, Samples, type = "left")
  
  Nutrients_sample<-Nutrients[duplicated(Nutrients$Sample.ID), ]
  
  Nutrients_sample <- Nutrients_sample[(Nutrients_sample$RanA>1),]
  
  summary(Nutrients_sample)
  
  # Tall format
  Samples.tall <- gather(Nutrients_sample, Nutrient, Concentration, 
                      NH4:PO4.uM., factor_key=TRUE)
  
  samples2 <- spread(Samples.tall,sample, Concentration)

  summary(samples2)
  
  
  
 Sample_type<- ggplot(samples2, aes (Frozen, Chl))+
   geom_smooth(method = lm)+
  geom_point(aes(colour=Date),alpha=1, size=2, shape=21)+
  geom_abline(intercept = 0, slope = 1, linetype=2)+
   
  scale_y_continuous(#limits = c(0, 35),
                        breaks = seq(0,20, 2),  
  #                       expand = c(0, 0),
                        name=("Concentration (uM) - Chloroform"))+
  scale_x_continuous(#limits = c(0, 35),
                        breaks = seq(0,20, 2),  
  #                       expand = c(0, 0),
                        name=("Concentration (uM) - Frozen"))
  
Sample_type+facet_wrap(~Nutrient, scales = "free")
  
```

